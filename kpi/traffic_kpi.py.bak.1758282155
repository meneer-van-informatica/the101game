from flask import Flask, request, jsonify, make_response, Response
import time, threading, uuid

app = Flask(__name__)

TTL_SECONDS = 35
_sessions = {}   # sid -> last_seen (epoch)
_lock = threading.Lock()

def _now(): return time.time()

def _sweep(now=None):
    if now is None: now = _now()
    dead = [sid for sid, ts in _sessions.items() if now - ts > TTL_SECONDS]
    for sid in dead:
        _sessions.pop(sid, None)

def _active_count(now=None):
    if now is None: now = _now()
    return sum(1 for ts in _sessions.values() if now - ts <= TTL_SECONDS)

def _pad5(n): return str(int(n)).zfill(5)

@app.route("/kpi/pulse", methods=["POST","GET"])
def pulse():
    sid = request.cookies.get("sid") or uuid.uuid4().hex
    now = _now()
    with _lock:
        _sessions[sid] = now
        _sweep(now)
        cnt = _active_count(now)
    res = make_response(jsonify({"count": cnt, "sid": sid, "ttl": TTL_SECONDS}))
    res.headers["Cache-Control"] = "no-store"
    res.set_cookie("sid", sid, max_age=86400, secure=True, httponly=False, samesite="Lax")
    return res

@app.get("/kpi/traffic/read")
def traffic_read():
    # Lees actuele *concurrent* count
    with _lock:
        _sweep()
        cnt = _active_count()
    if request.args.get("json"):
        return jsonify({"count": cnt, "ttl": TTL_SECONDS})
    body = f"the101game â€” Traffic KPI\nDit is tijdelijk de enige live feature.\nTraffic: {_pad5(cnt)} live\n"
    return Response(body, mimetype="text/plain")

# Compat: laat /kpi/traffic bestaan (geen increment meer)
@app.get("/kpi/traffic")
def traffic_compat():
    with _lock:
        _sweep()
        cnt = _active_count()
    return jsonify({"count": cnt})

# Debug: lijst actieve sids (optioneel)
@app.get("/kpi/sessions")
def sessions():
    with _lock:
        _sweep()
        now = _now()
        items = sorted(((sid, now-ts) for sid, ts in _sessions.items() if now-ts <= TTL_SECONDS), key=lambda x: x[1])
    return jsonify({"active": len(items), "ttl": TTL_SECONDS, "sids": [{"sid": sid, "age_s": round(age,1)} for sid, age in items]})
