<!doctype html><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1">
<title>the101game — Arena</title>
<style>
  html,body{margin:0;background:#0b0d12;color:#eee;font:16px/1.35 system-ui}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  input,button{font:inherit;padding:8px;border-radius:8px;border:1px solid #333;background:#111;color:#eee}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .card{background:#0f1117;border:1px solid #222;border-radius:12px;padding:12px;margin-top:12px}
  .tok{border-bottom:1px dashed #333;padding:6px 0}
</style>
<div class="wrap">
  <h1>the101game — Arena</h1>
  <div class="card">
    <h3>Tok me</h3>
    <div class="row">
      <input id="from" placeholder="from alias" value="test">
      <input id="to"   placeholder="to alias">
      <input id="txt"  placeholder="message (max 280)">
      <button id="sendTok">Send Tok</button>
      <button id="wsBtn">WS Connect</button>
    </div>
    <div id="inbox" class="card" style="margin-top:12px"></div>
  </div>

  <div class="card">
    <h3>101 Test Fight (matchmaking)</h3>
    <div class="row">
      <input id="alias" placeholder="your alias" value="test">
      <input id="level" placeholder="level" value="0" style="width:120px">
      <button id="queue">Join Queue</button>
    </div>
    <pre id="match" style="white-space:pre-wrap"></pre>
  </div>
</div>
<script>
const BASE='/arena';
const q = s => document.querySelector(s);
function renderInbox(items){
  q('#inbox').innerHTML =
    '<b>Inbox</b>' + items.map(t => `<div class="tok"><b>${t.fromAlias}</b> → ${t.toAlias} <small>${new Date(t.ts).toLocaleString()}</small><br>${(t.text||'')}</div>`).join('') || '<i>empty</i>';
}
async function refreshInbox(){
  const to = q('#to').value.trim(); if(!to) return;
  const r = await fetch(`${BASE}/api/inbox?alias=${encodeURIComponent(to)}`).then(r=>r.json());
  if(r.ok) renderInbox(r.toks); else q('#inbox').textContent = r.err||'error';
}
q('#sendTok').onclick = async ()=>{
  const body = { fromAlias:q('#from').value.trim()||'anon', toAlias:q('#to').value.trim(), text:q('#txt').value.trim() };
  const r = await fetch(`${BASE}/api/tok`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body)}).then(r=>r.json());
  await refreshInbox();
};
q('#queue').onclick = async ()=>{
  const body = { alias:q('#alias').value.trim()||'anon', level:Number(q('#level').value)||0 };
  const r = await fetch(`${BASE}/api/match`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body)}).then(r=>r.json());
  q('#match').textContent = JSON.stringify(r,null,2);
};
let sock;
q('#wsBtn').onclick = ()=>{
  const a = q('#to').value.trim() || 'anon';
  if(sock && sock.readyState===1){ sock.close(); }
  sock = new WebSocket((location.protocol==='https:'?'wss':'ws')+'://'+location.host+`${BASE}/ws?alias=${encodeURIComponent(a)}`);
  sock.onmessage = ev => {
    try{ const m = JSON.parse(ev.data); if(m.type==='tok'){ refreshInbox(); } if(m.type==='match'){ q('#match').textContent = JSON.stringify(m,null,2);} }catch{}
  };
};
</script>
