<!doctype html><meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>the101game Â· PONG</title>
<style>
  :root{--w:412px;--h:915px;--c:#e6e6e6;--bg:#000;--a:#8bd}
  html,body{margin:0;height:100%;background:#0b0d12;color:var(--c);font:14px/1.35 ui-monospace,monospace}
  .wrap{display:grid;place-items:center;height:100%}
  .device{width:var(--w);height:var(--h);border:12px solid #1a1f29;border-radius:24px;background:var(--bg);display:flex;flex-direction:column;box-shadow:0 18px 48px #000a,inset 0 0 0 1px #0006}
  .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #111}
  .pill{background:#111;border:1px solid #222;border-radius:999px;padding:6px 10px;color:#ccc}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:8px;height:100%}
  .col{display:flex;flex-direction:column;gap:8px}
  .card{background:#000;border:1px solid #222;border-radius:12px;padding:10px}
  .screen{flex:1;display:grid;grid-template-rows:auto 1fr auto;gap:6px}
  pre{margin:0;white-space:pre;line-height:1.1}
  button{font:inherit;background:#111;border:1px solid #333;color:#ddd;border-radius:10px;padding:10px}
  .row{display:flex;gap:8px}
  .btn{flex:1}
  a{color:var(--a)}
</style>
<div class="wrap">
  <div class="device">
    <div class="bar">
      <div class="pill">alias: <span id="aliasLbl">test</span></div>
      <div class="pill">kukels: <span id="kukels">0</span></div>
      <div class="pill">lvl: <span id="lvl">0000</span></div>
    </div>
    <div class="grid">
      <div class="col screen card">
        <div class="row"><b>ASCII PONG</b><span id="hud" style="margin-left:auto"></span></div>
        <pre id="game" aria-label="field"></pre>
        <div class="row">
          <button id="up" class="btn">â–² omhoog</button>
          <button id="down" class="btn">â–¼ omlaag</button>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <div><b>alias wisselen</b></div>
          <div class="row">
            <input id="aliasI" placeholder="alias" style="flex:1;background:#111;border:1px solid #222;border-radius:8px;color:#ddd;padding:8px" />
            <button id="aliasB">ok</button>
          </div>
          <small>default: <code>test</code></small>
        </div>
        <div class="card">
          <div><b>online (pancake)</b></div>
          <div id="pancake"></div>
        </div>
        <div class="card">
          <div><b>scorebord</b></div>
          <div id="board"></div>
        </div>
        <div class="card"><small><a href="/stack/">stack</a> Â· <a href="/">home</a></small></div>
      </div>
    </div>
  </div>
</div>
<script>
  const A = localStorage.getItem('alias') || 'test';
  const aliasLbl = document.getElementById('aliasLbl');
  const kukels = document.getElementById('kukels');
  const lvl = document.getElementById('lvl');
  const pancake = document.getElementById('pancake');
  const board = document.getElementById('board');
  const hud = document.getElementById('hud');
  const pre = document.getElementById('game');
  const up = document.getElementById('up'), down = document.getElementById('down');
  const aliasI = document.getElementById('aliasI'), aliasB = document.getElementById('aliasB');
  aliasLbl.textContent = A;

  const W=42,H=20; // ASCII field
  let ws, pad=H/2|0, last=0;
  const draw=(state={})=>{
    let s=[];
    for(let y=0;y<H;y++){
      let row=[];
      for(let x=0;x<W;x++){
        let ch=' ';
        if(x===0||x===W-1||y===0||y===H-1) ch='#';
        if(state.ball && x===state.ball.x && y===state.ball.y) ch='o';
        if(state.enemy && x===state.enemy.x && y===state.enemy.y) ch='x';
        if(state.paddles){ state.paddles.forEach(p=>{
          if(x===p.x && y>=p.y && y<p.y+p.h) ch='|';
        });}
        row.push(ch);
      }
      s.push(row.join(''));
    }
    pre.textContent=s.join('\n');
    hud.textContent = state.msg||'';
    lvl.textContent = state.level||'0000';
  };

  async function api(p,q){ const r=await fetch(p,q); return r.json().catch(()=>({})); }
  async function refresh(){
    const me = await api('/pong/api/me');
    aliasLbl.textContent = me.alias||A;
    kukels.textContent = me.kukels||0;
    const lb = await api('/pong/api/leaderboard');
    board.innerHTML = (lb.top||[]).map((t,i)=>`${i+1}. ${t.alias||t.side||'?'} â€” ${t.wins||t.kukels||0}`).join('<br>') || 'â€”';
  }
  aliasB.onclick = async ()=>{
    const n = aliasI.value.trim()||'test';
    localStorage.setItem('alias', n);
    await api('/pong/api/alias', {method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({alias:n})});
    aliasLbl.textContent=n; connect();
  };

  function connect(){
    try{ ws && ws.close(); }catch(e){}
    const alias = localStorage.getItem('alias')||'test';
    const url = (location.protocol==='https:'?'wss://':'ws://')+location.host+'/pong/ws?alias='+encodeURIComponent(alias);
    ws = new WebSocket(url);
    ws.onopen = ()=>{ refresh(); };
    ws.onmessage = e=>{
      const msg = JSON.parse(e.data||'{}');
      if(msg.type==='state') draw(msg.state);
      if(msg.type==='pancake') pancake.innerHTML = msg.list.map(a=>'ðŸ§‡ '+a).join('<br>');
      if(msg.type==='me'){ kukels.textContent=msg.kukels||0; }
    };
    ws.onclose = ()=> setTimeout(connect, 1500);
  }
  addEventListener('keydown',e=>{
    if(e.repeat) return;
    if(e.key==='ArrowUp')  ws?.send(JSON.stringify({t:'move',dy:-1}));
    if(e.key==='ArrowDown')ws?.send(JSON.stringify({t:'move',dy:+1}));
  });
  up.onclick=()=> ws?.send(JSON.stringify({t:'move',dy:-1}));
  down.onclick=()=> ws?.send(JSON.stringify({t:'move',dy:+1}));

  draw(); connect(); refresh();
</script>
