<!doctype html>
<html lang="nl">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>w0l1 · team (audio continues)</title>
<style>
:root{--bg:#000;--fg:#eaeaea;--line:#222;--pad:10px;--hbar:44px}
*{box-sizing:border-box}html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:15px/1.35 ui-monospace,consolas,monospace}
.bar{position:fixed;top:0;left:0;right:0;height:var(--hbar);display:flex;align-items:center;gap:8px;
     padding:calc(env(safe-area-inset-top) + 0px) var(--pad) 0 var(--pad);border-bottom:1px solid var(--line);
     background:#000000e6;backdrop-filter:blur(2px);z-index:10}
.btn{height:28px;display:inline-flex;align-items:center;gap:6px;padding:0 10px;border:1px solid var(--line);background:#111;color:var(--fg);border-radius:6px;text-decoration:none}
#wrap{position:fixed;left:0;right:0;top:calc(var(--hbar) + env(safe-area-inset-top));bottom:env(safe-area-inset-bottom);padding:var(--pad);display:grid;grid-template-rows:auto 1fr;gap:10px}
.card{border:1px solid var(--line);border-radius:10px;padding:10px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.label{opacity:.75;min-width:68px}
.inp{flex:1 1 180px;padding:.5rem .6rem;border:1px solid var(--line);background:#0f0f0f;color:var(--fg);border-radius:6px}
.genders{display:flex;gap:6px}
.genders .btn{height:auto;padding:.45rem .7rem}
.kb{display:grid;grid-template-columns:repeat(10,1fr);gap:6px}
.kb button{padding:.55rem 0;border:1px solid var(--line);background:#111;color:var(--fg);border-radius:6px}
 small.hint{opacity:.65}
.list{display:flex;gap:6px;flex-wrap:wrap}
.badge{border:1px solid var(--line);border-radius:6px;padding:4px 6px;opacity:.9}
</style>
<body>
<div class='page-meter'><select id='pspeed'><option value='5'>5s</option><option value='10' selected>10s</option><option value='30'>30s</option></select><div class='pbar'><div id='pfill' class='pfill'></div><div class='pval'><span id='pval'>1.0</span></div></div></div>
<div class="bar">
  <a class="btn" href="/">← home</a>
  <a class="btn" href="/w0l0.html">w0l0</a>
  <a class="btn" href="/w0l2.html">w0l2</a>
  <button id="save" class="btn">save</button>
  <button id="clear" class="btn">clear</button>
</div>

<div id="wrap">
  <div class="card">
    <div class="row"><div class="label">name</div><input id="name" class="inp" placeholder="a–z" maxlength="32"></div>
    <div class="row"><div class="label">age</div><input id="age"  class="inp" placeholder="0–9" maxlength="3"></div>
    <div class="row">
      <div class="label">gender</div>
      <div class="genders">
        <button type="button" class="btn g" data-g="m">m</button>
        <button type="button" class="btn g" data-g="o">o</button>
        <button type="button" class="btn g" data-g="v">v</button>
      </div>
      <input id="gender" class="inp" style="max-width:60px;text-align:center" placeholder="m/o/v" maxlength="1">
    </div>
  </div>

  <div class="card" id="kbwrap">
    <div class="row" style="justify-content:space-between"><div><b>click or type</b></div><small class="hint">active field: <span id="active">name</span></small></div>
    <div class="kb" id="kb"></div>
    <div class="row list" id="team"></div>
  </div>
</div>

<script>
/* ===== continue audio from w0l0 (no visual), vol fixed at 100 ===== */
let ac, comp, preGain, master, unlocked=false;
function initAudio(){ if(ac) return;
  ac=new (window.AudioContext||window.webkitAudioContext)();
  preGain=ac.createGain(); preGain.gain.value=4.0;
  comp=ac.createDynamicsCompressor(); comp.threshold.value=-24; comp.knee.value=15; comp.ratio.value=20; comp.attack.value=0.002; comp.release.value=0.25;
  master=ac.createGain(); master.gain.value=1.5; // ≈ 100
  preGain.connect(comp); comp.connect(master); master.connect(ac.destination);
}
function unlockOnce(){ if(unlocked) return; initAudio(); (ac.resume?ac.resume():Promise.resolve()).finally(()=>{unlocked=true;['pointerdown','touchstart','keydown'].forEach(t=>document.removeEventListener(t,unlockOnce,true))})}
['pointerdown','touchstart','keydown'].forEach(t=>document.addEventListener(t,unlockOnce,{capture:true,passive:true}));

// same math
const W=40,H=400,FALL_MS=parseInt(localStorage.getItem('w_audio_fallMs')||'2400',10),
      SPAWN_MS=parseInt(localStorage.getItem('w_audio_spawnMs')||'5000',10);
function colorForX(x){ const h=120*(x/(W-1)); return `hsl(${h} 90% 50% / .65)`; }
function freqForX(x){ const f0=261.63; const span=24; const semi=(x/(W-1))*span; return f0*Math.pow(2, semi/12); }
function fallTick(x,y){ initAudio(); if(ac.state==='suspended') ac.resume(); const t=ac.currentTime;
  const f=freqForX(x)*(0.85+0.3*(y/H));
  const o=ac.createOscillator(), g=ac.createGain(); o.type='square'; o.frequency.setValueAtTime(f,t);
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(1,t+0.004); g.gain.exponentialRampToValueAtTime(0.0001,t+0.06);
  o.connect(g); g.connect(preGain); o.start(t); o.stop(t+0.08);
}
function playChordForX(x){ initAudio(); if(ac.state==='suspended') ac.resume(); const root=freqForX(x), t0=ac.currentTime+0.02;
  [0,4,7].forEach((i,k)=>{ const o=ac.createOscillator(), g=ac.createGain(); o.type='triangle'; o.frequency.value=root*Math.pow(2,i/12);
    g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(0.9,t0+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t0+0.35);
    o.connect(g); g.connect(preGain); o.start(t0+k*0.004); o.stop(t0+0.4); });
}
// lcg
function lcg(seed){ let s=seed>>>0; return ()=> (s=((s*1664525+1013904223)>>>0), s); }
function pickX(rand){ const r=rand(); return Math.floor((r/4294967295) * W); }

(function continueAudio(){
  if(localStorage.getItem('w_audio_continue')!=='1') return; // alleen als we van w0l0 komen
  const seqStart = parseInt(localStorage.getItem('w_audio_seqStart')||String(Date.now()),10);
  const seed = parseInt(localStorage.getItem('w_audio_seed')||String(seqStart),10);
  const rng = lcg(seed);

  // skip rng vooruit tot huidige blokindex
  const elapsed = Date.now()-seqStart;
  let idx = Math.floor(elapsed/SPAWN_MS);
  for(let i=0;i<idx;i++) rng(); // consume

  let x = pickX(rng);
  let blockStart = seqStart + idx*SPAWN_MS;

  function loop(){
    const now = Date.now();
    // nieuwe blok?
    if(now >= blockStart + SPAWN_MS){
      idx++; x = pickX(rng); blockStart += SPAWN_MS; playChordForX(x);
    }
    // valfase binnen huidige blok
    const tIn = Math.max(0, Math.min(FALL_MS, now - blockStart));
    const y   = (tIn / FALL_MS) * H;
    // tick per ~12 rijen: gebruik modulo-drempel
    const step = 12, phase = Math.floor(y/step);
    if (!loop._last || phase>loop._last){ loop._last = phase; fallTick(x,y); }
    requestAnimationFrame(loop);
  }
  playChordForX(x);
  loop();
})();
</script>

<!-- team ui (zoals eerder) -->
<script>
(function(){
  const el=(id)=>document.getElementById(id), name=el('name'), age=el('age'), gender=el('gender'),
        activeLbl=el('active')||{textContent:''}, teamBox=document.getElementById('team');
  const AZ=[...'abcdefghijklmnopqrstuvwxyz'], D9=[...'0123456789'], G3=['m','o','v'];
  function cleanName(){ name.value=(name.value||'').toLowerCase().replace(/[^a-z]/g,''); }
  function cleanAge(){ age.value=(age.value||'').replace(/[^0-9]/g,'').slice(0,3); }
  function cleanGender(){ gender.value=(gender.value||'').toLowerCase().replace(/[^mov]/g,'').slice(0,1); }
  name?.addEventListener('input',cleanName); age?.addEventListener('input',cleanAge); gender?.addEventListener('input',cleanGender);
  document.querySelectorAll('.g').forEach(b=>b.addEventListener('click',()=>{ gender.value=b.dataset.g; gender.focus(); }));
  function load(){ try{return JSON.parse(localStorage.getItem('team_members')||'[]')}catch(_){return[]} }
  function save(a){ localStorage.setItem('team_members', JSON.stringify(a)) }
  function render(){ const t=load(); if(teamBox) teamBox.innerHTML=t.map(m=>`<span class="badge">${m.name} · ${m.age} · ${m.gender}</span>`).join(''); }
  document.getElementById('save')?.addEventListener('click',()=>{ cleanName(); cleanAge(); cleanGender();
    const nm=name?.value, ag=age?.value, gd=gender?.value; if(!nm||!ag||!G3.includes(gd)){ alert('fill: name a–z, age 0–9, gender m/o/v'); return; }
    const t=load(); t.push({name:nm,age:parseInt(ag,10),gender:gd,ts:Date.now()}); save(t); render(); if(name) name.value=''; if(age) age.value=''; if(gender) gender.value=''; });
  document.getElementById('clear')?.addEventListener('click',()=>{ localStorage.removeItem('team_members'); render(); });
  render();
})();
</script>
<script>(function(){
  var keyDur = 'timer:' + location.pathname;
  function getDur(){ try{ var v=parseInt(localStorage.getItem(keyDur)||'0',10); return (v>0?v:10);}catch(e){return 10;} }
  function setDur(s){ try{ localStorage.setItem(keyDur, String(s)); }catch(e){} }

  var ac, pre, comp, master, nextTick=0, raf=0, t0=0, DUR=10;
  function initAudio(){ if(ac) return; var C=window.AudioContext||window.webkitAudioContext; if(!C) return;
    ac=new C(); pre=ac.createGain(); pre.gain.value=4.0;
    comp=ac.createDynamicsCompressor(); comp.threshold.value=-24; comp.knee.value=15; comp.ratio.value=20; comp.attack.value=0.002; comp.release.value=0.25;
    master=ac.createGain(); master.gain.value=0.18; pre.connect(comp); comp.connect(master); master.connect(ac.destination);
  }
  function prime(){ try{initAudio(); if(ac&&ac.state==='suspended'&&ac.resume) return ac.resume();}catch(e){} return Promise.resolve(); }
  function snare(at){
    if(!ac) return; var len=ac.sampleRate*0.16, buf=ac.createBuffer(1,len,ac.sampleRate), data=buf.getChannelData(0);
    for(var i=0;i<len;i++){ data[i]=Math.random()*2-1; }
    var src=ac.createBufferSource(); src.buffer=buf;
    var bp=ac.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1800; bp.Q.value=0.9;
    var hp=ac.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=600;
    var g=ac.createGain(); g.gain.setValueAtTime(0.8,at); g.gain.exponentialRampToValueAtTime(0.0001,at+0.14);
    src.connect(bp); bp.connect(hp); hp.connect(g); g.connect(pre); src.start(at); src.stop(at+0.16);
  }

  function start(){
    DUR=getDur();
    var fill=document.getElementById('pfill'), val=document.getElementById('pval'), sel=document.getElementById('pspeed');
    if(!fill||!val) return;
    if(sel){ ['5','10','30'].forEach(function(v){ if(String(DUR)===v) sel.value=v; });
      sel.addEventListener('change', function(){ setDur(parseInt(sel.value,10)||10); start(); }); }
    if(raf) cancelAnimationFrame(raf); t0=performance.now(); nextTick=0;

    function loop(now){
      var frac=(now-t0)/(DUR*1000); if(frac>1) frac=1;
      var value=1-frac; fill.style.width=(value*100)+'%'; val.textContent=value.toFixed(1);
      var bpm=60+(240-60)*(1-value), interval=60/bpm, nowS=now/1000;
      if(!nextTick||nowS>=nextTick){ prime().then(function(){ if(!ac) return; var t=ac.currentTime+0.02; snare(t); }); nextTick=nowS+interval; }
      if(frac>=1){ location.assign('/w0l2.html'); return; }
      raf=requestAnimationFrame(loop);
    }
    raf=requestAnimationFrame(loop);
  }

  window.addEventListener('pointerdown', function(){ try{initAudio();}catch(e){} }, {once:true,capture:true});
  document.addEventListener('DOMContentLoaded', start);
})();</script>
</body>
</html>

