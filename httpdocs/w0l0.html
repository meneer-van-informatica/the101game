<!doctype html>
<html lang="nl">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>w0l0 · kiss+music (ramp)</title>
<style>
  :root{--bg:#000;--fg:#eaeaea;--line:#2a2a2a;--hbar:44px;--pad:8px}
  *{box-sizing:border-box}html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:15px/1.4 ui-monospace,consolas,monospace}
  .bar{position:fixed;top:0;left:0;right:0;height:var(--hbar);
       padding:calc(env(safe-area-inset-top) + 0px) var(--pad) 0 var(--pad);
       display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--line);
       background:#000000e6;backdrop-filter:blur(2px);z-index:10}
  .btn{height:28px;display:inline-flex;align-items:center;gap:6px;padding:0 10px;border:1px solid var(--line);background:#111;color:var(--fg);border-radius:6px;text-decoration:none}
  .meter{margin-left:auto;display:flex;align-items:center;gap:6px}
  .meter input{width:120px}
  #wrap{position:fixed;left:0;right:0;top:calc(var(--hbar) + env(safe-area-inset-top));bottom:env(safe-area-inset-bottom);padding:6px var(--pad)}
  #view{position:relative;width:100%;height:100%;border:1px dashed #444;overflow:hidden;
        background-image:
          repeating-linear-gradient(to right, rgba(255,255,255,.10) 0 1px, transparent 1px calc(100%/40)),
          repeating-linear-gradient(to bottom, rgba(255,255,255,.10) 0 1px, transparent 1px calc(100%/400));}
  .blk{position:absolute;left:0;top:0;width:calc(100%/40);height:calc(100%/400);outline:1px solid #555;border-radius:2px}
  #legend{position:absolute;left:8px;right:8px;top:8px;height:6px;border-radius:3px;border:1px solid #333;opacity:.9;background:linear-gradient(90deg,hsl(0 90% 50%),hsl(120 90% 50%))}
</style>
<body>
  <div class="bar">
    <a class="btn" href="/">← home</a>
    <button id="stop"  class="btn">stop</button>
    <button id="reset" class="btn">reset</button>
    <div class="meter"><span>vol</span><input id="vol" type="range" min="0" max="100" step="1" value="0"></div>
  </div>
  <div id="autoplay-gate" role="dialog" aria-modal="true">
  <div class="card">
    <b>tap to start sound</b>
    <div class="tip">(volume bouwt van 0 → 100 tijdens eerste blok)</div>
  </div>
</div>
<div id="wrap"><section id="view" aria-label="tetris 40x400"><div id="legend"></div></section></div>

<script>
/* ===== audio core (loud chain) ===== */
let ac, comp, preGain, master, unlocked=false;
function initAudio(){ if(ac) return;
  ac=new (window.AudioContext||window.webkitAudioContext)();
  preGain=ac.createGain(); preGain.gain.value=4.0;
  comp=ac.createDynamicsCompressor(); comp.threshold.value=-24; comp.knee.value=15; comp.ratio.value=20; comp.attack.value=0.002; comp.release.value=0.25;
  master=ac.createGain(); master.gain.value=0.0; // start stil
  preGain.connect(comp); comp.connect(master); master.connect(ac.destination);
}
function unlockOnce(){ if(unlocked) return; initAudio(); (ac.resume?ac.resume():Promise.resolve()).finally(()=>{unlocked=true;['pointerdown','touchstart','keydown'].forEach(t=>document.removeEventListener(t,unlockOnce,true))})}
['pointerdown','touchstart','keydown'].forEach(t=>document.addEventListener(t,unlockOnce,{capture:true,passive:true}));

// slider 0..100 -> master gain ~ 0..1.5 (met preamp is dit heel luid)
function setVolume(v=0){ initAudio();
  const n=Math.max(0,Math.min(100,Number(v))); master.gain.value=n/66.6; // 100≈1.5
  const el=document.getElementById('vol'); if(el) el.value=String(n);
  localStorage.setItem('w_audio_vol', String(n));
}

/* ===== shared math (seeded rng, mapping) ===== */
const W=40,H=400,FALL_MS=2400,SPAWN_MS=5000;
function colorForX(x){ const h=120*(x/(W-1)); return `hsl(${h} 90% 50% / .65)`; }
function freqForX(x){ const f0=261.63; const span=24; const semi=(x/(W-1))*span; return f0*Math.pow(2, semi/12); }
// lcg rng
function lcg(seed){ let s=seed>>>0; return ()=> (s=((s*1664525+1013904223)>>>0), s); }
function pickX(rand, idx){ const r=rand(); return Math.floor((r/4294967295) * W); }
// ticks & chord
function fallTick(x,y){ initAudio(); if(ac.state==='suspended') ac.resume(); const t=ac.currentTime;
  const f=freqForX(x)*(0.85+0.3*(y/H));
  const o=ac.createOscillator(), g=ac.createGain();
  o.type='square'; o.frequency.setValueAtTime(f,t);
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(1,t+0.004); g.gain.exponentialRampToValueAtTime(0.0001,t+0.06);
  o.connect(g); g.connect(preGain); o.start(t); o.stop(t+0.08);
}
function playChordForX(x){ initAudio(); if(ac.state==='suspended') ac.resume(); const root=freqForX(x), t0=ac.currentTime+0.02;
  [0,4,7].forEach((i,k)=>{ const o=ac.createOscillator(), g=ac.createGain(); o.type='triangle'; o.frequency.value=root*Math.pow(2,i/12);
    g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(0.9,t0+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t0+0.35);
    o.connect(g); g.connect(preGain); o.start(t0+k*0.004); o.stop(t0+0.4); });
}

/* ===== visual fall with volume ramp on first block ===== */
const view=document.getElementById('view'); let firstLanded=false;
const seqStart = (localStorage.getItem('w_audio_seqStart')? Number(localStorage.getItem('w_audio_seqStart')) : Date.now());
localStorage.setItem('w_audio_seqStart', String(seqStart));
const rng = lcg(seqStart);
localStorage.setItem('w_audio_seed', String(seqStart)); // zelfde waarde
localStorage.setItem('w_audio_spawnMs', String(SPAWN_MS));
localStorage.setItem('w_audio_fallMs',  String(FALL_MS));

function spawnAndDrop(idx){
  const x=pickX(rng, idx);
  const blk=document.createElement('div'); blk.className='blk';
  blk.style.left=(x*100/W)+'%'; blk.style.top='0%'; blk.style.background=colorForX(x);
  view.appendChild(blk);

  // chord bij spawn
  playChordForX(x);

  const t0=performance.now(); const end=t0+FALL_MS;
  let lastLine=-1;
  function step(now){
    const p = Math.min(1, (now - t0)/FALL_MS);
    const y = p*H;
    blk.style.top=(y*100/H)+'%';

    // ticks elke 12 rijen
    const line = Math.floor(y/12);
    if(line>lastLine){ lastLine=line; fallTick(x,y); }

    // volume rampen tijdens eerste blok
    if(!firstLanded){
      const vol = Math.round(p*100);
      setVolume(vol);
    }

    if(now<end){ requestAnimationFrame(step); }
    else{
      if(!firstLanded){
        firstLanded=true;
        setVolume(100);
        // flag voor w0l1 dat audio moet doorgaan
        localStorage.setItem('w_audio_continue','1');
        setTimeout(()=>location.assign('/w0l1.html'),200);
      }
      blk.remove();
    }
  }
  requestAnimationFrame(step);
}

// controls
document.getElementById('reset').onclick=(e)=>{e.preventDefault(); firstLanded=false; setVolume(0); spawnAndDrop(0); };
document.getElementById('stop').onclick=(e)=>{e.preventDefault(); try{ac&&ac.close()}catch(_){}; localStorage.removeItem('w_audio_continue'); };
document.getElementById('vol').oninput=(e)=>setVolume(e.target.value);

// start: volume 0, eerste spawn nu; daarna spawnen we wel door maar we gaan toch naar w0l1 bij eerste landing
setVolume(0);
spawnAndDrop(0);
</script>
<script>
/* autoplay gate */
(function(){
  const gate = document.getElementById('autoplay-gate');

  async function tryStartSilently(){
    // probeer direct: init + resume + vol=0
    try{ initAudio(); setVolume?.(0); }catch(_){}
    try{
      if (ac && ac.state === 'suspended') await ac.resume();
    }catch(_){}
    // beslis
    if (ac && ac.state === 'running'){
      hideGate(); // succes → geen tik nodig
      return true;
    }
    showGate();   // fallback: toon overlay
    return false;
  }

  function showGate(){ gate?.classList.add('show'); }
  function hideGate(){ gate?.classList.remove('show'); }

  // eerste interactie overal → unlock + verberg gate
  function userUnlock(){
    try{ initAudio(); }catch(_){}
    try{ ac && ac.resume && ac.resume(); }catch(_){}
    hideGate();
    window.removeEventListener('pointerdown', userUnlock, true);
    window.removeEventListener('keydown', userUnlock, true);
  }
  window.addEventListener('pointerdown', userUnlock, true);
  window.addEventListener('keydown',     userUnlock, true);
  gate?.addEventListener('click', userUnlock, {passive:true});

  // probeer meteen bij load (succès op desktop/engaged sites; mobiel/ios meestal niet)
  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    tryStartSilently();
  } else {
    document.addEventListener('DOMContentLoaded', tryStartSilently, {once:true});
  }
})();
</script></body>
</html>

