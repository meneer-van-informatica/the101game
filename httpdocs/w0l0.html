<!doctype html>
<html lang="nl">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>w0l0 · kiss</title>
<style>
  :root{--bg:#000;--fg:#eaeaea;--line:#2a2a2a;--accent:#ffd400;--hbar:44px;--pad:8px}
  *{box-sizing:border-box}html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:15px/1.4 ui-monospace,consolas,monospace}
  /* toolbar */
  .bar{position:fixed;top:0;left:0;right:0;height:var(--hbar);
       padding:calc(env(safe-area-inset-top) + 0px) var(--pad) 0 var(--pad);
       display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--line);
       background:#000000e6;backdrop-filter:blur(2px);z-index:10}
  .btn{height:28px;display:inline-flex;align-items:center;gap:6px;padding:0 10px;border:1px solid var(--line);background:#111;color:var(--fg);border-radius:6px;text-decoration:none}
  .meter{margin-left:auto;display:flex;align-items:center;gap:6px}
  .meter input{width:120px}
  /* viewport fills the rest (above the fold, no scroll) */
  #wrap{position:fixed;left:0;right:0;top:calc(var(--hbar) + env(safe-area-inset-top));bottom:env(safe-area-inset-bottom);padding:6px var(--pad)}
  #view{position:relative;width:100%;height:100%;border:1px dashed #444;overflow:hidden;
        /* 40×400 grid as lightweight background */
        background-image:
          repeating-linear-gradient(to right, rgba(255,255,255,.12) 0 1px, transparent 1px calc(100%/40)),
          repeating-linear-gradient(to bottom, rgba(255,255,255,.12) 0 1px, transparent 1px calc(100%/400));
        background-size: 100% 100%, 100% 100%; background-origin: content-box; background-clip: content-box;
  }
  /* one falling block */
  .blk{position:absolute;left:0;top:0;width:calc(100%/40);height:calc(100%/400);
       background:color-mix(in oklab, var(--accent) 45%, #000 55%); outline:1px solid #555; border-radius:2px}
</style>
<body>
  <div class="bar">
    <a class="btn" href="/">← home</a>
    <button id="stop"  class="btn">stop</button>
    <button id="reset" class="btn">reset</button>
    <div class="meter"><span>vol</span><input id="vol" type="range" min="0" max="1000" step="10" value="1000"></div>
  </div>

  <div id="wrap">
    <section id="view" aria-label="tetris 40x400"></section>
  </div>

<script>
/* ===== audio (very loud; default 1000) ===== */
let ac, comp, preGain, master, unlocked=false;
function initAudio(){
  if(ac) return;
  ac = new (window.AudioContext||window.webkitAudioContext)();
  preGain = ac.createGain(); preGain.gain.value = 4.0; // preamp
  comp = ac.createDynamicsCompressor(); comp.threshold.value=-24; comp.knee.value=15; comp.ratio.value=20; comp.attack.value=0.002; comp.release.value=0.25;
  master = ac.createGain(); master.gain.value=1.0; // master (we scale with setVolume)
  preGain.connect(comp); comp.connect(master); master.connect(ac.destination);
}
function unlockOnce(){ if(unlocked) return; initAudio(); (ac.resume?ac.resume():Promise.resolve()).finally(()=>{unlocked=true;['pointerdown','touchstart','keydown'].forEach(t=>document.removeEventListener(t,unlockOnce,true))})}
['pointerdown','touchstart','keydown'].forEach(t=>document.addEventListener(t,unlockOnce,{capture:true,passive:true}));
function setVolume(v=1000){ initAudio(); const g=Math.max(0,Math.min(1000,Number(v))); master.gain.value=g/666; localStorage.setItem('w0l0_volume',String(v)); }
(function(){ setVolume(parseInt(localStorage.getItem('w0l0_volume')||'1000',10)); })();

function tick(){ initAudio(); if(ac.state==='suspended') ac.resume(); const t=ac.currentTime;
  {const o=ac.createOscillator(),g=ac.createGain();o.type='square';o.frequency.setValueAtTime(1600,t);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(1,t+0.003);g.gain.exponentialRampToValueAtTime(0.0001,t+0.05);o.connect(g);g.connect(preGain);o.start(t);o.stop(t+0.07)}
  {const o=ac.createOscillator(),g=ac.createGain();o.type='sine';o.frequency.setValueAtTime(160,t);o.frequency.exponentialRampToValueAtTime(110,t+0.09);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(1,t+0.006);g.gain.exponentialRampToValueAtTime(0.0001,t+0.12);o.connect(g);g.connect(preGain);o.start(t);o.stop(t+0.14)}
}

/* ===== kiss fall: 1 block drops; on land -> w0l1 ===== */
const W=40, H=400, view=document.getElementById('view');
function spawnAndDrop(){
  view.querySelectorAll('.blk').forEach(n=>n.remove());
  const blk=document.createElement('div'); blk.className='blk';
  const x=Math.floor(Math.random()*W);
  blk.style.left=(x*100/W)+'%'; blk.style.top='0%'; view.appendChild(blk);
  let y=0, vy=0.25; // speed
  const step=()=>{ y+=vy; blk.style.top=(y*100/H)+'%';
    if(y>=H-1){ tick(); setTimeout(()=>location.assign('/w0l1.html'),250); return; }
    requestAnimationFrame(step);
  };
  tick(); requestAnimationFrame(step);
}
document.getElementById('reset').onclick=(e)=>{e.preventDefault(); spawnAndDrop();}
document.getElementById('stop').onclick=(e)=>{e.preventDefault(); try{ac&&ac.close()}catch(_){}}
document.getElementById('vol').oninput=(e)=>setVolume(e.target.value);
spawnAndDrop();
</script>
</body>
</html>
