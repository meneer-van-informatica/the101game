<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>w0l0 · mama + seconds + snare</title>
<style>
  :root{ --phone-w:min(100vw,420px); --bg:#000; --fg:#eaeaea; --line:#2a2a2a; --h:64px }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.4 ui-monospace,consolas,monospace}
  #phone{width:var(--phone-w);min-height:100dvh;margin:0 auto}
  .bar{position:sticky;top:0;z-index:10;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;
       padding:10px;border-bottom:1px solid var(--line);background:#000000e8;backdrop-filter:blur(2px)}
  .msg{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .right{display:flex;gap:10px;align-items:center}
  .btn{height:30px;display:inline-flex;align-items:center;gap:6px;padding:0 10px;border:1px solid var(--line);background:#111;color:var(--fg);border-radius:6px;text-decoration:none}
  .meter input{width:120px}
  #wrap{padding:8px}
  #view{position:relative;width:100%;height:60vh;border:1px dashed #444;overflow:hidden;
        background-image:
          repeating-linear-gradient(to right, rgba(255,255,255,.10) 0 1px, transparent 1px calc(100%/40)),
          repeating-linear-gradient(to bottom, rgba(255,255,255,.10) 0 1px, transparent 1px calc(100%/400));}
  .blk{position:absolute;left:0;top:0;width:calc(100%/40);height:calc(100%/400);outline:1px solid #555;border-radius:2px}
  #legend{position:absolute;left:8px;right:8px;top:8px;height:6px;border-radius:3px;border:1px solid #333;opacity:.9;background:linear-gradient(90deg,hsl(0 90% 50%),hsl(120 90% 50%))}
  #autoplay-gate{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.65);z-index:99999}
  #autoplay-gate.show{display:grid}
  #autoplay-gate .card{color:#eaeaea;background:#0b0b0bcc;border:1px solid #222;border-radius:12px;padding:14px 16px;text-align:center;max-width:320px}
  #autoplay-gate .tip{opacity:.8;font-size:.9em}
</style>
<body>
<div id="phone">
  <div class="bar">
    <div class="left">
      <div class="msg" id="m1">...</div>
      <div class="msg" id="m2">...</div>
    </div>
    <div class="right">
      <span id="clock">-- -- ---- --:--:--</span>
      <div class="meter"><span>vol</span><input id="vol" type="range" min="0" max="100" step="1" value="0"></div>
      <a class="btn" href="/">home</a>
    </div>
  </div>
  <div id="wrap">
    <section id="view" aria-label="tetris 40x400">
      <div id="legend" aria-hidden="true"></div>
    </section>
  </div>
</div>

<div id="autoplay-gate" role="dialog" aria-modal="true">
  <div class="card">
    <b>tap to start sound</b>
    <div class="tip">(volume from 0 -> 100 during first block)</div>
  </div>
</div>

<script>
/* lang + text */
(function(){
  const L=localStorage.getItem('site_lang')||'en';
  document.documentElement.setAttribute('lang',L);
  function pad(n){return String(n).padStart(2,'0')}
  function fmt(d){
    const dd=pad(d.getDate());
    const month=d.toLocaleString(L==='en'?'en-US':'nl-NL',{month:'long'});
    const yyyy=d.getFullYear();
    const HH=pad(d.getHours()), MM=pad(d.getMinutes()), SS=pad(d.getSeconds());
    return `${dd} ${month} ${yyyy} ${HH}:${MM}:${SS}`;
  }
  function render(){
    const d=fmt(new Date());
    if(L==='nl'){
      document.getElementById('m1').textContent='hallo mama.';
      document.getElementById('m2').textContent=('de klok zegt '+d).toLowerCase()+' · case: 1';
    }else{
      document.getElementById('m1').textContent='HELLO MAMA.';
      document.getElementById('m2').textContent=('THE CLOCK SAYS '+d).toUpperCase()+' · CASE: 0';
    }
  }
  setInterval(render,250); render();
})();

/* clock */
(function(){
  const el=document.getElementById('clock');
  function pad(n){return String(n).padStart(2,'0')}
  function fmt(d){
    const L=localStorage.getItem('site_lang')||'en';
    const dd=pad(d.getDate());
    const month=d.toLocaleString(L==='en'?'en-US':'nl-NL',{month:'long'});
    const yyyy=d.getFullYear();
    const HH=pad(d.getHours()), MM=pad(d.getMinutes()), SS=pad(d.getSeconds());
    return `${dd} ${month} ${yyyy} ${HH}:${MM}:${SS}`;
  }
  setInterval(()=>{ el.textContent=fmt(new Date()); }, 250);
})();

/* audio core */
let ac, pre, comp, master;
function initAudio(){ if(ac) return;
  ac=new (window.AudioContext||window.webkitAudioContext)();
  pre=ac.createGain(); pre.gain.value=4.0;
  comp=ac.createDynamicsCompressor(); comp.threshold.value=-24; comp.knee.value=15; comp.ratio.value=20; comp.attack.value=0.002; comp.release.value=0.25;
  master=ac.createGain(); master.gain.value=0.0;
  pre.connect(comp); comp.connect(master); master.connect(ac.destination);
}
function setVolume(v=0){ initAudio(); const n=Math.max(0,Math.min(100,Number(v))); master.gain.value=n/66.6; const s=document.getElementById('vol'); if(s) s.value=String(n); }

/* unlock gate (uses intent from index if fresh) */
(function(){
  const gate=document.getElementById('autoplay-gate');
  function show(){gate.classList.add('show')} function hide(){gate.classList.remove('show')}
  function fresh(){ try{const ts=parseInt(localStorage.getItem('w_audio_intent_ts')||'0',10); return ts && (Date.now()-ts)<8000}catch(_){return false} }
  async function tryStart(){ try{initAudio(); setVolume(0);}catch(_){}
    try{ if(ac && ac.state==='suspended') await ac.resume(); }catch(_){}
    if(ac && ac.state==='running'){ hide(); return true } show(); return false }
  function firstTap(){ try{initAudio(); ac&&ac.resume&&ac.resume();}catch(_){}
    hide(); window.removeEventListener('pointerdown',firstTap,true); window.removeEventListener('keydown',firstTap,true); }
  window.addEventListener('pointerdown',firstTap,true); window.addEventListener('keydown',firstTap,true);
  if(fresh()) { try{initAudio(); ac&&ac.resume&&ac.resume(); setVolume(0);}catch(_){ } hide(); }
  (document.readyState==='complete'||document.readyState==='interactive') ? tryStart() : document.addEventListener('DOMContentLoaded', tryStart, {once:true});
})();

/* sound helpers (kick, snare, tick, chord) */
function kick(at=ac.currentTime){
  initAudio(); const o=ac.createOscillator(), g=ac.createGain();
  o.type='sine'; o.frequency.setValueAtTime(160,at); o.frequency.exponentialRampToValueAtTime(60, at+0.12);
  g.gain.setValueAtTime(0.9,at); g.gain.exponentialRampToValueAtTime(0.0001, at+0.14);
  o.connect(g); g.connect(pre); o.start(at); o.stop(at+0.16);
}
function snare(at=ac.currentTime){
  initAudio();
  // white noise burst
  const len=ac.sampleRate*0.25, buf=ac.createBuffer(1,len,ac.sampleRate), data=buf.getChannelData(0);
  for(let i=0;i<len;i++){ data[i]=Math.random()*2-1; }
  const src=ac.createBufferSource(); src.buffer=buf;
  const bp=ac.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1800; bp.Q.value=0.8;
  const hp=ac.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=600;
  const g=ac.createGain();
  g.gain.setValueAtTime(0.9,at); g.gain.exponentialRampToValueAtTime(0.0001, at+0.18);
  src.connect(bp); bp.connect(hp); hp.connect(g); g.connect(pre);
  src.start(at); src.stop(at+0.2);
  // metal "tss" (triangle burst)
  const o=ac.createOscillator(), g2=ac.createGain();
  o.type='triangle'; o.frequency.setValueAtTime(5000,at);
  g2.gain.setValueAtTime(0.35,at); g2.gain.exponentialRampToValueAtTime(0.0001,at+0.18);
  o.connect(g2); g2.connect(pre); o.start(at); o.stop(at+0.2);
}
function padumTss(){
  if(!ac) initAudio();
  const t=ac.currentTime;
  kick(t+0.00);          // pa
  kick(t+0.08);          // dum
  snare(t+0.16);         // tss
}
const W=40,H=400; const FALL_SLOW=3000, FALL_FAST=900; const SPAWN_MS=5000;
function freqForX(x){ const f0=261.63, span=24, semi=(x/(W-1))*span; return f0*Math.pow(2, semi/12); }
function chord(x){ initAudio(); if(ac.state==='suspended') ac.resume(); const root=freqForX(x), t0=ac.currentTime+0.02;
  [0,4,7].forEach((i,k)=>{ const o=ac.createOscillator(), g=ac.createGain(); o.type='triangle'; o.frequency.value=root*Math.pow(2,i/12);
    g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(0.9,t0+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t0+0.35);
    o.connect(g); g.connect(pre); o.start(t0+k*0.004); o.stop(t0+0.4); });
}
function tickSound(x,y){ initAudio(); if(ac.state==='suspended') ac.resume(); const t=ac.currentTime, f=freqForX(x)*(0.85+0.3*((y||0)/H));
  const o=ac.createOscillator(), g=ac.createGain(); o.type='square'; o.frequency.setValueAtTime(f,t);
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(1,t+0.004); g.gain.exponentialRampToValueAtTime(0.0001,t+0.06);
  o.connect(g); g.connect(pre); o.start(t); o.stop(t+0.08);
}
function currentFallMs(){ const s=(new Date()).getSeconds(); const a=s/59; return FALL_SLOW + (FALL_FAST - FALL_SLOW)*a; }

/* falling block visuals + landing snare */
const view=document.getElementById('view');
let firstLanded=false;
function spawnAndDrop(){
  const x=Math.floor(Math.random()*W);
  const blk=document.createElement('div'); blk.className='blk';
  blk.style.left=(x*100/W)+'%'; blk.style.top='0%'; blk.style.background=`hsl(${120*(x/(W-1))} 90% 50% / .65)`;
  view.appendChild(blk);
  chord(x);

  let y=0, last=performance.now(), lastTick=-1;
  function step(now){
    const dt=now-last; last=now;
    const fm=currentFallMs(); y += (H/fm)*dt;
    if(!firstLanded){ const p=Math.max(0,Math.min(1,y/H)); setVolume(Math.round(p*100)); }
    const phase=Math.floor(y/12); if(phase>lastTick){ lastTick=phase; tickSound(x,y); }
    blk.style.top=(Math.min(y,H-1)*100/H)+'%';
    if(y>=H-1){
      if(!firstLanded){ firstLanded=true; setVolume(100); }
      padumTss();
      blk.remove(); return;
    }
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

setVolume(0); spawnAndDrop();
const spawner=setInterval(()=>spawnAndDrop(), SPAWN_MS);
document.getElementById('vol').oninput=(e)=>setVolume(e.target.value);
</script>
<script>
/* block register */
(function(){
  function wrap(id, key){
    const el = document.getElementById(id);
    if(!el) return;
    if(el.parentElement && el.parentElement.classList && el.parentElement.classList.contains('blk')) return; // al gewrapt
    const w = document.createElement('div');
    w.className = 'blk'; w.dataset.b = key;
    el.parentNode.insertBefore(w, el);
    w.appendChild(el);
  }
  function run(){
    wrap('m1',     '0.0.0'); // HELLO/HALLO MAMA
    wrap('m2',     '0.1.0'); // THE CLOCK SAYS / de klok zegt
    wrap('clock',  '1.0.0'); // klok (rechts in bar)
    // volume slider zit in .meter; geef 'm zelf een id als die nog niet bestond
    const meter = document.querySelector('.meter'); if(meter && !meter.id) meter.id = 'meter';
    wrap('meter',  '1.1.0'); // volume
    const homeBtn = document.querySelector('.btn[href="/"]'); if(homeBtn && !homeBtn.id) homeBtn.id='homebtn';
    wrap('homebtn','1.2.0'); // home
    wrap('legend', '2.0.0'); // bovenste legend balk in viewport
    wrap('view',   '2.1.0'); // tetris viewport zelf
  }
  if (document.readyState==='complete'||document.readyState==='interactive') run();
  else document.addEventListener('DOMContentLoaded', run, {once:true});
})();
</script>
</body>
</html>

